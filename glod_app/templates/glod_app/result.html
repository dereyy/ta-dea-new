{% extends "base.html" %}

{% block title %}Hasil Analisis GLOD - GLOD Community Detector{% endblock %}
{% block extra_head %}
<style>
.page-title {
  font-size: 2rem;
  color: #1976d2;
  font-weight: 900;
  text-align: center;
  letter-spacing: 0.5px;
  margin-bottom: 25px;
}
.section-heading {
  color: #1976d2;
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 13px;
}
</style>
{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-center align-items-center mb-3">
    <h3 class="mb-0 page-title">Hasil Deteksi Komunitas</h3>
  </div>

  {% if error %}
  <div class="alert alert-danger">
    <i class="fas fa-exclamation-triangle"></i> {{ error }} 
    {% if error_detail %}
    <details class="mt-2">
      <summary>Detail Error</summary>
      <pre class="mt-2">{{ error_detail }}</pre>
    </details>
    {% endif %}
  </div>
  {% else %}
  <div class="row mb-4 g-3">

    <!-- Jumlah Komunitas -->
    <div class="col-md-3">
      <div class="card bg-primary text-white h-100 shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-title">Jumlah Komunitas</h6>
          <h2 class="mb-0">{{ num_communities }}</h2>
        </div>
      </div>
    </div>

    <!-- Normalized Node Cut -->
    <div class="col-md-3">
      <div class="card bg-info text-white h-100 shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-title">Normalized Node Cut (Ψ)</h6>
          <h2 class="mb-0">{{ avg_psi_node_cut }}</h2>
        </div>
      </div>
    </div>

    <!-- Total Nodes -->
    <div class="col-md-3">
      <div class="card bg-info text-white h-100 shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-title">Total Nodes</h6>
          <h2 class="mb-0">{{ total_nodes }}</h2>
        </div>
      </div>
    </div>

    <!-- Total Edges -->
    <div class="col-md-3">
      <div class="card bg-info text-white h-100 shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-title">Total Edges</h6>
          <h2 class="mb-0">{{ total_edges }}</h2>
        </div>
      </div>
    </div>

  </div>


  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title section-heading">Parameter yang Digunakan</h5>
      <div class="row">
        
          <p class="mb-1">α (Alpha)     :{{ alpha }}</p>
      
          <p class="mb-1">Threshold Jaccard : {{ jaccard_threshold }}</p>
       
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Visualisasi Jaringan dengan Komunitas</h5>
    </div>
    <div class="card-body">
      <div id="network-container" style="height: 700px; border: 1px solid #ddd"></div>

      <div class="mt-3">
        <button class="btn btn-success" onclick="downloadVisualization()">
          <i class="fas fa-download"></i> Download Visualisasi PNG
        </button>
        <div class="btn-group" role="group">
          <button class="btn btn-info" onclick="downloadCommunityData('csv')">
            <i class="fas fa-file-csv"></i> Download CSV
          </button>
          <button class="btn btn-info" onclick="downloadCommunityData('xlsx')">
            <i class="fas fa-file-excel"></i> Download XLSX
          </button>
        </div>
        </button>
      </div>

      <div class="mt-3">
        <h6>Legend Warna Komunitas:</h6>
        <div class="d-flex flex-wrap">
          {% for color in color_palette %}
          <div class="me-3 mb-2">
            <span class="badge" style="background-color: {{ color }}; color: white; padding: 8px 12px;">
              Komunitas {{ forloop.counter }}
            </span>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Detail Komunitas</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Komunitas ID</th>
              <th>Jumlah Anggota</th>
              <th>Jumlah Overlap</th>
              <th>Anggota Protein</th>
              <th>Protein Overlap</th>
              <th>Normalized Node Cut (Ψ)</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            {% for community in communities %}
            <tr id="community-row-{{ community.id }}">
              <td>
                <span class="badge" style="background-color: {{ color_palette|slice:forloop.counter0|slice:1 }}; color: white; font-size: 14px; padding: 6px 10px;">
                  Komunitas {{ community.id }}
                </span>
              </td>
              <td><strong>{{ community.size }}</strong></td>
              <td><strong>{{ community.overlap_count }}</strong></td>
              <td>
                <details>
                  <summary>Lihat {{ community.size }} anggota</summary>
                  <div class="mt-2" style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
                    {% for member in community.members %}
                    <span class="badge bg-secondary me-1 mb-1">{{ member }}</span>
                    {% endfor %}
                  </div>
                </details>
              </td>
              <td>
                {% if community.overlap_count > 0 %}
                <details>
                  <summary>Lihat {{ community.overlap_count }} overlap</summary>
                  <div class="mt-2" style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
                    {% for member in community.overlap_members %}
                    <span class="badge bg-warning text-dark me-1 mb-1">{{ member }}</span>
                    {% endfor %}
                  </div>
                </details>
                {% else %}
                <span class="badge bg-success">Tidak ada overlap</span>
                {% endif %}
              </td>
              <td>
                <span class="badge bg-info text-white" style="font-size: 14px; padding: 6px 10px;">
                  {{ community.psi }}
                </span>
              </td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="toggleCommunityVisualization({{ community.id }})">
                  <i class="fas fa-chart-network"></i> Tampilkan Komunitas
                </button>
                <button class="btn btn-sm btn-success" onclick="handleEnrichmentClick({{ community.id }})">
                  <i class="fas fa-flask"></i> Analisis Enrichment
                </button>
              </td>
            </tr>
            <tr id="visualization-row-{{ community.id }}" style="display: none;">
              <td colspan="7">
                <div style="padding: 15px; background-color: #f8f9fa; border-radius: 4px;">
                  <div style="margin-bottom: 10px;">
                    <strong>Visualisasi Komunitas {{ community.id }}</strong>
                    <button class="btn btn-sm btn-secondary float-end" onclick="toggleCommunityVisualization({{ community.id }})">
                      <i class="fas fa-times"></i> Sembunyikan
                    </button>
                  </div>
                  <div id="community-network-container-{{ community.id }}" style="height: 400px; border: 1px solid #ddd; border-radius: 4px;"></div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Statistik Komunitas</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <canvas id="communitySizeChart"></canvas>
        </div>
        <div class="col-md-6">
          <h6>Ringkasan Statistik</h6>
          <table class="table table-sm">
            <tr>
              <td>Ukuran Komunitas Terbesar:</td>
              <td><strong id="max-size">-</strong></td>
            </tr>
            <tr>
              <td>Ukuran Komunitas Terkecil:</td>
              <td><strong id="min-size">-</strong></td>
            </tr>
            <tr>
              <td>Rata-rata Ukuran Komunitas:</td>
              <td><strong id="avg-size">-</strong></td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Section Enrichment Analysis Results -->
  <div class="card mb-4" id="enrichment-results-section" style="display: none;">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="fas fa-flask"></i> Hasil Analisis Enrichment
        <button class="btn-close float-end" onclick="closeEnrichmentResults()" style="background-color: transparent; border: none;"></button>
      </h5>
    </div>
    <div class="card-body">
      <!-- Loading spinner -->
      <div id="enrichment-loading" style="display: none; text-align: center;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Sedang memproses...</span>
        </div>
        <p class="mt-2">Sedang melakukan enrichment analysis... Ini mungkin memakan waktu beberapa menit.</p>
      </div>

      <!-- Results container -->
      <div id="enrichment-results-container" style="display: none;">
        <div class="row mb-3">
          <div class="col-md-6">
            <h6>Informasi Analisis</h6>
            <table class="table table-sm table-borderless">
              <tr>
                <td><strong>Komunitas ID:</strong></td>
                <td id="enrichment-community-id">-</td>
              </tr>
              <tr>
                <td><strong>Jumlah Gene Dianalisis:</strong></td>
                <td id="enrichment-gene-count">-</td>
              </tr>
              <tr>
                <td><strong>Total Hasil Signifikan:</strong></td>
                <td id="enrichment-result-count">-</td>
              </tr>
            </table>
          </div>
          <div class="col-md-6">
            <h6>Download Hasil</h6>
            <button class="btn btn-sm btn-info" onclick="downloadEnrichmentResults('csv')">
              <i class="fas fa-file-csv"></i> Download CSV
            </button>
            <button class="btn btn-sm btn-info" onclick="downloadEnrichmentResults('xlsx')">
              <i class="fas fa-file-excel"></i> Download XLSX
            </button>
          </div>
        </div>

        <h6>Top 20 Hasil Enrichment (Tertinggi -log10 p-value)</h6>
        <div class="table-responsive">
          <table class="table table-striped table-hover table-sm">
            <thead class="table-dark">
              <tr>
                <th>Sumber (Database)</th>
                <th>Gene ID</th>
                <th>Nama Fungsi/Pathway</th>
                <th>P-value</th>
                <th>-log10(p-value)</th>
                <th>Signifikan</th>
              </tr>
            </thead>
            <tbody id="enrichment-results-table">
              <!-- Results akan ditambahkan di sini oleh JavaScript -->
            </tbody>
          </table>
        </div>

        <div class="alert alert-info mt-3">
          <strong>Penjelasan:</strong>
          <ul class="mb-0 mt-2">
            <li><strong>-log10(p-value):</strong> Semakin tinggi nilainya, semakin signifikan hasil tersebut</li>
            <li><strong>Sumber:</strong> GO:BP (Biological Process), GO:MF (Molecular Function), GO:CC (Cellular Component), KEGG (Pathways)</li>
            <li><strong>Signifikan:</strong> Hasil dengan p-value < 0.05 ditandai sebagai signifikan</li>
          </ul>
        </div>
      </div>

      <!-- Error container -->
      <div id="enrichment-error-container" style="display: none;">
        <div class="alert alert-danger">
          <strong>Error:</strong> <span id="enrichment-error-message"></span>
        </div>
      </div>
    </div>
  </div>

  {% endif %}
</div>

{% if not error %}
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
  // Parse data dari Django
  const visNodes = {{ vis_nodes|safe }};
  const visEdges = {{ vis_edges|safe }};
  const communities = {{ communities|safe }};
  const colorPalette = {{ color_palette|safe }};

  // Buat DataSet untuk vis.js
  const nodes = new vis.DataSet(visNodes.map(node => ({
    id: node.id,
    label: node.label,
    title: node.title,
    color: {
      background: node.color,
      border: '#2B7CE9',
      highlight: {
        background: node.color,
        border: '#000000'
      }
    },
    font: {
      size: 12,
      color: '#000'
    },
    communities: node.communities
  })));

  const edges = new vis.DataSet(visEdges.map(edge => ({
    from: edge.from,
    to: edge.to,
    color: {
      color: '#cccccc',
      highlight: '#000000'
    },
    width: 2
  })));

  // Konfigurasi network
  const options = {
    physics: {
      enabled: true,
      stabilization: {
        iterations: 200,
        updateInterval: 50
      },
      barnesHut: {
        gravitationalConstant: -3000,
        centralGravity: 0.3,
        springLength: 150,
        springConstant: 0.04,
        damping: 0.95,
        avoidOverlap: 0.5
      }
    },
    nodes: {
      shape: 'dot',
      size: 20,
      borderWidth: 2,
      font: {
        size: 12,
        face: 'Arial'
      }
    },
    edges: {
      width: 2,
      smooth: {
        type: 'continuous'
      }
    },
    interaction: {
      hover: true,
      tooltipDelay: 100,
      zoomView: true,
      dragView: true
    }
  };

  const container = document.getElementById('network-container');
  const network = new vis.Network(container, { nodes: nodes, edges: edges }, options);

  // Stabilization callback
  network.on("stabilizationIterationsDone", function() {
    network.setOptions({ physics: { enabled: false } });
    network.fit();
  });

  // Download visualization
  function downloadVisualization() {
    const canvas = document.querySelector('#network-container canvas');
    if (canvas) {
      const link = document.createElement('a');
      link.download = 'glod-communities-' + new Date().getTime() + '.png';
      link.href = canvas.toDataURL('image/png', 1.0);
      link.click();
    }
  }

  // Download community data as Excel
  function downloadCommunityData() {
    if (typeof XLSX === 'undefined') {
      alert('Library XLSX belum dimuat.');
      return;
    }

    const data = communities.map(comm => ({
      'Komunitas ID': comm.id,
      'Jumlah Anggota': comm.size,
      'Anggota': comm.members.join(', ')
    }));

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);

    ws['!cols'] = [
      { width: 15 },
      { width: 15 },
      { width: 100 }
    ];

    XLSX.utils.book_append_sheet(wb, ws, "Communities");

    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
    const filename = `glod-communities-${timestamp}.xlsx`;

    XLSX.writeFile(wb, filename);
  }

  // Chart untuk ukuran komunitas
  const ctx = document.getElementById('communitySizeChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: communities.map(c => 'C' + c.id),
      datasets: [{
        label: 'Ukuran Komunitas',
        data: communities.map(c => c.size),
        backgroundColor: colorPalette,
        borderColor: colorPalette.map(c => c),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'Distribusi Ukuran Komunitas'
        },
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Jumlah Node'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Komunitas'
          }
        }
      }
    }
  });

  // Hitung statistik komunitas
  const communitySizes = communities.map(c => c.size);
  const totalSize = communitySizes.reduce((sum, size) => sum + size, 0);
  const avgSize = (totalSize / communities.length).toFixed(2);
  const maxSize = Math.max(...communitySizes);
  const minSize = Math.min(...communitySizes);

  document.getElementById('avg-size').textContent = avgSize;
  document.getElementById('max-size').textContent = maxSize;
  document.getElementById('min-size').textContent = minSize;

  // Fungsi download data komunitas
  function downloadCommunityData(format = 'csv') {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "download_community_data" %}';
    
    // Tambahkan CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
      form.appendChild(csrfToken.cloneNode(true));
    }
    
    // Tambahkan format
    const formatInput = document.createElement('input');
    formatInput.type = 'hidden';
    formatInput.name = 'format';
    formatInput.value = format;
    form.appendChild(formatInput);
    
    // Tambahkan data komunitas
    const communitiesInput = document.createElement('input');
    communitiesInput.type = 'hidden';
    communitiesInput.name = 'communities_json';
    communitiesInput.value = JSON.stringify(communities);
    form.appendChild(communitiesInput);
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
  }

  // Fungsi download visualisasi (stub untuk sekarang)
  function downloadVisualization() {
    alert('Fitur download visualisasi PNG belum diimplementasikan');
  }

  // Menyimpan network instances untuk setiap komunitas
  const communityNetworks = {};

  // Fungsi untuk toggle visualisasi komunitas
  function toggleCommunityVisualization(communityId) {
    const visualizationRow = document.getElementById(`visualization-row-${communityId}`);
    const container = document.getElementById(`community-network-container-${communityId}`);
    
    if (visualizationRow.style.display === 'none') {
      visualizationRow.style.display = 'table-row';
      
      // Jika belum di-render, render sekarang
      if (!communityNetworks[communityId]) {
        renderCommunityNetwork(communityId, container);
      } else {
        // Jika sudah ada, refresh ukuran container
        setTimeout(() => {
          communityNetworks[communityId].fit();
        }, 100);
      }
    } else {
      visualizationRow.style.display = 'none';
    }
  }

  // Fungsi untuk render jaringan komunitas
  function renderCommunityNetwork(communityId, container) {
    // Filter nodes dan edges yang termasuk komunitas ini
    const communityNodes = visNodes.filter(node => node.communities.includes(communityId));
    const communityNodeIds = new Set(communityNodes.map(node => node.id));
    const communityEdges = visEdges.filter(edge => 
      communityNodeIds.has(edge.from) && communityNodeIds.has(edge.to)
    );

    // Buat DataSet untuk komunitas ini
    const commNodes = new vis.DataSet(communityNodes.map(node => ({
      id: node.id,
      label: node.label,
      title: node.label,
      color: {
        background: node.color,
        border: '#2B7CE9',
        highlight: {
          background: node.color,
          border: '#000000'
        }
      },
      font: {
        size: 14,
        color: '#000',
        bold: { color: '#000' }
      }
    })));

    const commEdges = new vis.DataSet(communityEdges.map(edge => ({
      from: edge.from,
      to: edge.to,
      color: {
        color: '#999999',
        highlight: '#000000'
      },
      width: 2
    })));

    // Konfigurasi untuk komunitas network
    const options = {
      physics: {
        enabled: true,
        stabilization: {
          iterations: 200,
          updateInterval: 50,
          fit: true
        },
        barnesHut: {
          gravitationalConstant: -2000,
          centralGravity: 0.3,
          springLength: 100,
          springConstant: 0.05,
          damping: 0.95,
          avoidOverlap: 0.5
        }
      },
      nodes: {
        shape: 'dot',
        size: 25,
        borderWidth: 2,
        font: {
          size: 14,
          face: 'Arial'
        }
      },
      edges: {
        width: 2,
        smooth: {
          type: 'continuous',
          forceDirection: 'none',
          roundness: 0.5
        }
      },
      interaction: {
        hover: true,
        zoomView: true,
        dragView: true
      },
      configure: false
    };

    // Render network
    const data = { nodes: commNodes, edges: commEdges };
    communityNetworks[communityId] = new vis.Network(container, data, options);
  }

  // ===== ENRICHMENT ANALYSIS FUNCTIONS =====
  
  // Simpan data enrichment untuk download
  let currentEnrichmentData = {
    communityId: null,
    allData: [],
    topData: []
  };

  function handleEnrichmentClick(communityId) {
    console.log('handleEnrichmentClick - communityId:', communityId);
    
    // Cari komunitas di array communities
    const community = communities.find(c => c.id === communityId);
    
    if (!community) {
      alert('Komunitas tidak ditemukan');
      return;
    }
    
    const genes = community.members;
    console.log('Community members:', genes);
    performEnrichmentAnalysis(communityId, genes);
  }

  function performEnrichmentAnalysis(communityId, geneList) {
    console.log('performEnrichmentAnalysis called with communityId:', communityId, 'geneList:', geneList);
    
    // Validasi gene list
    if (!geneList || (Array.isArray(geneList) && geneList.length === 0)) {
      alert('Daftar gene tidak lengkap atau kosong untuk komunitas ini');
      return;
    }
    
    // Jika geneList bukan array, pastikan itu array
    let genes = Array.isArray(geneList) ? geneList : [geneList];
    console.log('Genes to analyze:', genes);

    // Tampilkan loading spinner
    document.getElementById('enrichment-loading').style.display = 'block';
    document.getElementById('enrichment-results-container').style.display = 'none';
    document.getElementById('enrichment-error-container').style.display = 'none';
    document.getElementById('enrichment-results-section').style.display = 'block';

    // Scroll ke section enrichment
    document.getElementById('enrichment-results-section').scrollIntoView({ behavior: 'smooth' });

    // Siapkan data untuk dikirim ke server
    const formData = new FormData();
    formData.append('community_id', communityId);
    formData.append('genes_json', JSON.stringify(genes));
    formData.append('organism', 'hsapiens');  // Default untuk human

    // Kirim request ke server
    fetch('{% url "enrichment_analysis" %}', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
      }
    })
    .then(response => response.json())
    .then(data => {
      document.getElementById('enrichment-loading').style.display = 'none';
      
      if (!data.success) {
        // Tampilkan error
        document.getElementById('enrichment-error-container').style.display = 'block';
        document.getElementById('enrichment-error-message').textContent = data.error || 'Error tidak diketahui';
        return;
      }

      // Simpan data untuk download
      currentEnrichmentData.communityId = communityId;
      currentEnrichmentData.allData = data.all_data || [];
      currentEnrichmentData.topData = data.data || [];

      // Tampilkan hasil
      displayEnrichmentResults(communityId, data);
    })
    .catch(error => {
      document.getElementById('enrichment-loading').style.display = 'none';
      document.getElementById('enrichment-error-container').style.display = 'block';
      document.getElementById('enrichment-error-message').textContent = 'Error: ' + error.message;
    });
  }

  function displayEnrichmentResults(communityId, data) {
    // Update informasi analisis
    document.getElementById('enrichment-community-id').textContent = `Komunitas ${communityId}`;
    document.getElementById('enrichment-gene-count').textContent = data.gene_analyzed;
    document.getElementById('enrichment-result-count').textContent = data.total_results;

    // Buat tabel hasil
    const tableBody = document.getElementById('enrichment-results-table');
    tableBody.innerHTML = '';

    if (data.data && data.data.length > 0) {
      data.data.forEach(row => {
        const tr = document.createElement('tr');
        
        // Format kolom
        const source = row.source || '-';
        const nativeId = row.native || '-';
        const name = row.name || '-';
        const pValue = row.p_value !== undefined ? parseFloat(row.p_value).toExponential(2) : '-';
        const log10p = row['-log10p'] !== undefined ? parseFloat(row['-log10p']).toFixed(2) : '-';
        const significant = row.significant === true ? '<span class="badge bg-success">Ya</span>' : '<span class="badge bg-secondary">Tidak</span>';

        tr.innerHTML = `
          <td>${source}</td>
          <td><code>${nativeId}</code></td>
          <td>${name}</td>
          <td>${pValue}</td>
          <td><strong>${log10p}</strong></td>
          <td>${significant}</td>
        `;
        tableBody.appendChild(tr);
      });
    } else {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="6" class="text-center text-muted">Tidak ada hasil signifikan</td>';
      tableBody.appendChild(tr);
    }

    // Tampilkan results container
    document.getElementById('enrichment-results-container').style.display = 'block';
  }

  function closeEnrichmentResults() {
    document.getElementById('enrichment-results-section').style.display = 'none';
    currentEnrichmentData = { communityId: null, allData: [], topData: [] };
  }

  function downloadEnrichmentResults(format) {
    if (!currentEnrichmentData.communityId || currentEnrichmentData.allData.length === 0) {
      alert('Tidak ada data untuk didownload');
      return;
    }

    const formData = new FormData();
    formData.append('community_id', currentEnrichmentData.communityId);
    formData.append('format', format);
    formData.append('results_json', JSON.stringify(currentEnrichmentData.allData));

    // Kirim download request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "download_enrichment_results" %}';

    for (let [key, value] of formData.entries()) {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = key;
      input.value = value;
      form.appendChild(input);
    }

    // Tambahkan CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrfmiddlewaretoken';
      csrfInput.value = csrfToken.value;
      form.appendChild(csrfInput);
    }

    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
  }
</script>
{% endif %} 
{% endblock %}
